# JAX Vessels

![Wave Pattern Visualization](docs/wave_pattern.png)

The visualization above shows the **free surface elevation** (wave height) generated by the KVLCC2 tanker hull moving at speed.
*   **Color Scale**: Represents wave height in meters relative to the calm water line (Z=0).
    *   **Red**: Crests (positive elevation).
    *   **Blue**: Troughs (negative elevation).
    *   **Range**: The scale is clamped to **[-5, 5] meters** to clearly highlight the steady-state [Kelvin wake pattern](https://en.wikipedia.org/wiki/Kelvin_wake), characterized by divergent and transverse waves.
*   **Note**: Transient start-up effects can produce larger "splash" values (up to +/- 40m) at the boundaries, which are saturated in this view to focus on the hydrodynamics around the hull.
*   **Method**: Extracted from the Volume of Fluid (VOF) field `alpha.water` isosurface at 0.5.

## Overview

This repository contains tools for:
1.  **Procedural Hull Generation**: Creating parametric ship geometries (Tankers, Barges) using Python and Blender.
2.  **CFD Integration**: Automated mesh generation and resistance simulation using OpenFOAM.
3.  **Optimization**: Using JAX to learning and minimize resistance surrogates.

## Simulation Methodology

This project utilizes a robust OpenFOAM-based CFD pipeline to model ship hydrodynamics.

### Test Case Hierarchy
We build up the complexity of the simulation in steps to validate the physics incrementally:

| Case Name | Description | Physics Verified | Key Features |
| :--- | :--- | :--- | :--- |
| **1. still_water** | Water and air at rest in a box. | Hydrostatic stability, Phase conservation. | `blockMesh` only, No ship, Flat surface. |
| **2. inverse_barometer** | Standard pressure gradient applied to surface. | Pressure-Elevation coupling (Inverse Barometer). | `codedFixedValue` BC, Tilted surface. |
| **3. wave_tank** | A wave propagating through the domain. | Momentum advection, Interface capturing (VOF). | Initialized wave/dam-break, simple mesh. |
| **4. kcs_hull** | Ship hull in open water. | Fluid-Structure Interaction, Turbulence. | `snappyHexMesh`, Turbulence Model, `forces`. |

### Modelling Approach
The simulation uses the **Volume of Fluid (VOF)** method to capture the free surface (water-air interface) using the `interFoam` solver.

*   **Real World Element** -> **Model Representation**
    *   Ship Hull -> STL Surface (No-slip wall)
    *   Ocean/Air -> Multiphase Fluid (`alpha.water` field: 0=air, 1=water)
    *   Open Sea -> Rectangular Computational Domain with RANS + k-Omega SST turbulence modelling.

#### Frame of Reference
The simulation utilizes a **body-fixed Eulerian reference frame**.
*   **Stationary Ship**: The ship hull is fixed in space ($U_{ship} = 0$).
*   **Moving Water**: The water flows past the hull with a defined velocity.
*   This mimics a circulating water channel test and avoids dynamic mesh motion complexity.

![Numerical Scheme Mesh](docs/mesh_slice.png)
*Figure: Cross-section of the mesh generation showing the immersed boundary representation.*

## Documentation
*   [OpenFOAM Case Setup](docs/openfoam_setup.md): Explanation of the simulation template.
*   [Test Case Templates](templates/base_case/README.md): Detailed documentation of the specific templates.

## Running Test Cases

The `templates/` directory contains standard OpenFOAM cases.

### Automated Execution (Recommended)
We provide a helper script to run standard verification cases inside the Docker container automatically, handling parallel execution and setup.

```bash
# Run the KCS Hull verification case (runs in parallel on 6 cores)
./scripts/run_docker.sh ./scripts/verify_case.sh kcs_hull
```

### Manual Execution
To run a test case manually (e.g., `kcs_hull`):

1.  **Copy the template** to a run directory to keep the original clean:
    ```bash
    mkdir -p simulations
    cp -r templates/kcs_hull simulations/my_kcs_test
    cd simulations/my_kcs_test
    ```

2.  **Generate Mesh and Fields**:
    ```bash
    blockMesh
    surfaceFeatureExtract
    snappyHexMesh -overwrite
    setFields
    ```

3.  **Run Simulation**:
    *   **Serial**:
        ```bash
        interFoam
        ```
    *   **Parallel (Faster)**:
        The case is configured for 6 cores (`system/decomposeParDict`).
        ```bash
        decomposePar
        mpirun -np 6 interFoam -parallel
        reconstructPar
        ```

4.  **Visualize (ParaView)**:
    Convert results to VTK format:
    ```bash
    foamToVTK
    ```
    Open the generated `.vtk` files in the `VTK/` directory using ParaView.

## Validation

We provide an automated test suite using `pytest` to verify the physical correctness of the templates.

```bash
# Run physics verification tests
pytest tests/test_physics.py
```

## Installation
This project uses `uv` for dependency management.

```bash
# Install dependencies
uv sync
```

## Hull Generation

We provide two methods for generating hull geometries:

### 1. Blender Geometry Nodes (Recommended)
Produces high-quality, organic, and simulation-ready meshes using Blender's procedural node system.

> [!NOTE]
> Requires **Blender 4.0** or later (for STL export support).

```bash
# Generate KVLCC2 Tanker (320m) with Bulbous Bow
blender -b -P examples/scripts/blender_ship_geonodes.py
```

### 2. Python Procedural Script
Fast, standalone generation of basic shapes without Blender dependency.

```bash
# Generate Tanker
python examples/scripts/generate_hull.py --type tanker --out examples/hulls/tanker_kvlcc2_like.stl

# Generate Inland Barge
python examples/scripts/generate_hull.py --type barge --out examples/hulls/barge_inland.stl
```

## Hydrostatics Analysis

We provide a tool to quickly check the hydrostatic properties (displacement, center of buoyancy, etc.) of any STL hull geometry using `meshmagick`.

```bash
# Check hydrostatics for a hull
./scripts/check_hydrostatics.sh <path_to_stl> [water_density] [vertical_cog]
```

Example:
```bash
./scripts/check_hydrostatics.sh templates/kcs_hull/constant/triSurface/hull.stl 1025 0
```


## Running with Docker
We recommend using Docker to ensure a consistent OpenFOAM environment with all dependencies.

1.  **Build the Image**:
    ```bash
    ./scripts/run_docker.sh build
    # Or manually: docker build -t jax-vessels .
    ```

2.  **Run a Simulation**:
    Use the provided wrapper to execute commands inside the container with the current directory mounted:
    ```bash
    ./scripts/run_docker.sh ./scripts/verify_case.sh kcs_hull
    ```
    
    This will:
    *   Setup the case in `verification_run/kcs_hull`.
    *   Run `blockMesh`, `snappyHexMesh` (with watertight hull).
    *   Run `interFoam` in **parallel (6 cores)**.
    *   Automatically run `foamToVTK` for visualization.

3.  **Run Tests**:
    ```bash
    docker run --rm -it -v $(pwd):/app --entrypoint pytest ship-model tests/
    ```

### Manual Execution in Docker
If you want to run specific OpenFOAM commands manually (debugging):
```bash
# Start a shell with OpenFOAM environment sourced
docker run --rm -it -v $(pwd):/app ship-model run-analysis bash
```
Then, inside the container:
```bash
# Example: Run explicit steps on a test case
cd simulations/my_test_case
blockMesh
checkMesh
foamToVTK
```

## Example Hulls

The `examples/hulls/` directory contains generated STL files ready for simulation.

> [!IMPORTANT]
> When adding new hulls, ensure they meet the [Hull Geometry Requirements](docs/hull_requirements.md) (e.g., watertightness, correct origin).

### `tanker_geometry_node.stl`
**Type**: KVLCC2-like VLCC Tanker  
**Dimensions**: 320m x 58m x 30m  
**Features**:
*   **High-Fidelity Bulbous Bow**: Generated via volumetric fusion of an ellipsoidal primitive and the hull body, resulting in a smooth, organic transition.
*   **CFD-Ready Topology**: Remeshed using a uniform Voxel Grid (0.5m) to produce a structured, quad-dominant mesh ideal for `snappyHexMesh`.
*   **Watertight**: Guaranteed manifold geometry due to the volume-to-mesh workflow.

### `tanker_kvlcc2_like.stl`
**Type**: KVLCC2-like Tanker Representation  
**Dimensions**: ~320m length  
**Features**:
*   Generated using pure Python/Numpy mathematical profiles.
*   Explicit mesh construction with a parametric bulbous bow.
*   Good for quick iterate-and-test loops where Blender is not available.

### `barge_inland.stl`
**Type**: CEMT Type IIa Inland Push Barge  
**Dimensions**: 76.5m x 11.4m x 3.5m  
**Features**:
*   Standardized European inland waterway dimensions.
*   Box-shaped midbody with parameterized bow and stern rakes.
*   Suitable for shallow water resistance studies.

### `simple_box.stl`
**Type**: Simple Cuboid  
**Dimensions**: 100m x 20m x 10m (Default)  
**Features**:
*   Pure rectangular geometry ("Shoebox"), ideal for initial verification of the OpenFOAM numerical setup without complex mesh features.
*   Generated via `python examples/scripts/generate_hull.py --type box`.

### `barge_geonodes.stl`
**Type**: Parametric Inland Barge (Procedural)  
**Dimensions**: 135m x 14.2m x 4m (Class Va)  
**Features**:
*   Generated using **Blender Geometry Nodes** (`examples/scripts/blender_barge_geonodes.py`).
*   Procedural mesh with configurable stations and profiles.
*   Features a tapered bow and raked stern.

### `barge_nurbs.stl`
**Type**: Parametric Inland Barge (NURBS)  
**Dimensions**: 135m x 14.2m x 4m (Class Va)  
**Features**:
*   Generated using **Python-driven NURBS Surfaces** (`examples/scripts/blender_nurbs_barge.py`).
*   Guaranteed C2 smoothness for high-quality hydrodynamics.
*   Explicitly modeled deck and transom for perfect watertight closure.
*   Pontoon-style hull with flat bottom and bilge radius.
